// This file is your Prisma schema, which specifies the database structure.

generator client {
  provider = "prisma-client-js"
}

// CRTICO: Aseg煤rate de que el proveedor sea "postgresql"
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ----------------------------------------------------------------------
// 1. MODELO USER (Simplificado al MNIMO para evitar conflicto)
// ----------------------------------------------------------------------

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  password     String
  firstName    String
  role         String 
  
  // Relaciones necesarias
  patients             PatientTherapist[] @relation(name: "TherapistPatients")
  assignedByTherapist  PatientTherapist[] @relation(name: "PatientTherapist")
}

// ----------------------------------------------------------------------
// 2. NUEVO MODELO PATIENTTHERAPIST (La tabla de relaciones)
// ----------------------------------------------------------------------

model PatientTherapist {
  // ID 煤nico de la relaci贸n
  id           String   @id @default(uuid()) 
  
  // Campo ID del Terapeuta y la relaci贸n con el modelo User
  therapistId  String
  therapist    User     @relation(name: "TherapistPatients", fields: [therapistId], references: [id])

  // Campo ID del Paciente y la relaci贸n con el modelo User
  patientId    String
  patient      User     @relation(name: "PatientTherapist", fields: [patientId], references: [id])

  // CRTICO: Campo de estado para archivar/activar la relaci贸n
  isActive     Boolean  @default(true)
  
  // Campos de fecha (opcionales, pero comunes)
  assignedAt   DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Restricci贸n para evitar duplicados
  @@unique([therapistId, patientId])
}

// ----------------------------------------------------------------------
// 3. NUEVO MODELO GOAL (Metas Terap茅uticas)
// ----------------------------------------------------------------------

model Goal {
  id          String   @id @default(uuid())
  title       String
  description String?
  metric      String?
  target      Int?
  dueDate     DateTime
  status      String   @default("PENDING") // PENDING, COMPLETED, ARCHIVED, etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaci贸n con el paciente (User)
  patientId   String
  patient     User     @relation("PatientGoals", fields: [patientId], references: [id])

  // Relaci贸n con el terapeuta (User)
  therapistId String
  therapist   User     @relation("TherapistGoals", fields: [therapistId], references: [id])
}

// ----------------------------------------------------------------------
// 4. NUEVO MODELO CHECKIN (Registros diarios o semanales)
// ----------------------------------------------------------------------

model Checkin {
  id          String   @id @default(uuid())
  date        DateTime @default(now())
  mood        String?  // Ej: 'happy', 'sad', 'neutral'
  notes       String?
  
  // Relaci贸n con el paciente (User)
  patientId   String
  patient     User     @relation("PatientCheckins", fields: [patientId], references: [id])
  
  // Restricci贸n 煤nica para asegurar solo un check-in por d铆a (opcional)
  @@unique([patientId, date])
}

// ----------------------------------------------------------------------
// 5. ACTUALIZACIN DEL MODELO USER (CRTICO)
// ----------------------------------------------------------------------

// Ahora tenemos que a帽adir las relaciones inversas a tu modelo User:
// Busca el modelo 'User' existente y a帽ade estas tres l铆neas:

// ... (dentro de model User { )
  // Tus l铆neas existentes:
  patients             PatientTherapist[] @relation(name: "TherapistPatients")
  assignedByTherapist  PatientTherapist[] @relation(name: "PatientTherapist")

  //  LNEAS NUEVAS A AADIR EN USER 
  checkins             Checkin[] @relation("PatientCheckins") // Relaci贸n con los checkins
  goalsCreatedBy       Goal[]    @relation("TherapistGoals")  // Metas creadas por el terapeuta
  goals                Goal[]    @relation("PatientGoals")    // Metas asignadas al paciente
// ... (cierre de model User } )