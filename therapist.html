<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coter - Interfaz Terapeuta</title>
    <style>
        :root {
            --primary-color: #e74c3c; /* Rojo Terapeuta (usado para Eliminar) */
            --secondary-color: #c0392b; /* Rojo oscuro (usado para botones principales) */
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --success-color: #2ecc71;
            --warning-color: #f39c12; /* Naranja (usado para Archivar) */
            --text-color: #333;
        }
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: var(--light-color); color: var(--text-color); }
        .app-container { max-width: 900px; margin: 40px auto; background-color: white; border-radius: 12px; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); overflow: hidden; min-height: 600px; }
        .header { background-color: var(--primary-color); color: white; padding: 20px; text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .content { padding: 20px; }
        .patient-card { background-color: #fceeee; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid var(--primary-color); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .patient-card button { background-color: var(--dark-color); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        .patient-card button:hover { background-color: #34495e; }
        h2 { border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; margin-top: 20px; color: var(--secondary-color); }
        .logout-button { background: none; border: 1px solid white; color: white; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        
        /* Estilos de la Vista de Detalle */
        #patient-details-view { border: 1px solid #ccc; padding: 20px; border-radius: 8px; margin-top: 20px; }
        #patient-details-view h3 { border-bottom: 1px solid #eee; padding-bottom: 5px; color: var(--dark-color); }
        
        /* Estilos para Check-ins */
        .checkin-card { background-color: #f7f7f7; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid var(--success-color); }
        .checkin-card .score { font-weight: bold; color: var(--success-color); margin-right: 10px; }

        /* Estilos para Metas */
        .goal-card-therapist { background-color: #fff9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #3498db; /* Azul */ }
        .status-badge { display: inline-block; padding: 5px 10px; border-radius: 12px; font-size: 0.8em; font-weight: bold; margin-left: 10px; }
        .status-PENDING { background-color: #f1c40f; color: var(--dark-color); }
        .status-IN_PROGRESS { background-color: #3498db; color: white; }
        .status-COMPLETED { background-color: var(--success-color); color: white; }
        .status-ARCHIVED { background-color: var(--dark-color); color: white; }

        /* Estilos del Modal */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe; 
            margin: 10% auto; 
            padding: 20px; 
            border: 1px solid #888; 
            width: 80%; 
            max-width: 600px; 
            border-radius: 8px;
        }
        .close-button {
            color: #aaa; 
            float: right; 
            font-size: 28px; 
            font-weight: bold; 
            cursor: pointer;
        }
        .modal-form input[type="text"], .modal-form input[type="number"], .modal-form input[type="date"], .modal-form textarea, .modal-form select {
            width: 100%; 
            padding: 8px; 
            border: 1px solid #ccc; 
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>

<div class="app-container">
    <header class="header">
        <h1>Coter - Interfaz Terapeuta</h1>
        <button class="logout-button" onclick="logout()">Cerrar Sesi√≥n</button>
    </header>

    <div class="content">

        <section style="margin-bottom: 30px;">
            <h2>üë§ Asignar Nuevo Paciente</h2>
            <div id="assign-message" style="margin-bottom: 10px;"></div>
            <form id="assign-form" onsubmit="event.preventDefault(); assignPatient(event.target)">
                <input type="email" id="patientEmail" placeholder="Email del Paciente" required style="width: 70%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <button type="submit" style="width: 25%; padding: 10px; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; float: right;">Asignar</button>
            </form>
        </section>
        <div id="patients-list-view">
            <h2>üìã Mis Pacientes Asignados</h2>
            <div id="patients-list">Cargando pacientes...</div>
        </div>

        <div id="patient-details-view" style="display: none;">
            <button onclick="showPatientListView()" style="margin-bottom: 15px; padding: 8px 15px; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">‚Üê Volver a la Lista</button>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="patient-detail-name">Detalles del Paciente</h2>
                <div id="patient-actions">
                    <button onclick="archivePatient()" style="padding: 8px 15px; background-color: var(--warning-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                        üì¶ Archivar Paciente
                    </button>
                    <button onclick="deletePatient()" style="padding: 8px 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                        üóëÔ∏è Eliminar Paciente
                    </button>
                </div>
            </div>

            <section>
                <h3>üìà Check-ins Recientes</h3>
                <div id="checkins-list">No hay check-ins recientes.</div>
            </section>

            <section style="margin-top: 20px; position: relative;">
                <h3>üéØ Metas Asignadas</h3>
                
                <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <label for="goalFilterStatus" style="font-weight: bold; margin-right: 15px;">Filtrar por Estado:</label>
                    <select id="goalFilterStatus" onchange="filterGoals()" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                        <option value="ALL">Todas las Metas</option>
                        <option value="PENDING">Pendientes</option>
                        <option value="IN_PROGRESS">En Progreso</option>
                        <option value="COMPLETED">Completadas</option>
                        <option value="ARCHIVED">Archivadas</option>
                    </select>
                    
                    <button id="create-goal-button" style="padding: 8px 15px; background-color: var(--dark-color); color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 15px;">+ Crear Meta</button>
                </div>

                <div id="goals-for-patient-list" style="margin-top: 10px;">Cargando metas...</div>
            </section>
        </div>

    </div>
</div>

<div id="goal-modal" class="modal">
    <div class="modal-content">
        <span onclick="closeModal()" class="close-button">&times;</span>
        <h2 id="modal-title">Crear Nueva Meta</h2>
        <div id="goal-form-message" style="margin-bottom: 10px;"></div>
        
        <form id="create-goal-form" onsubmit="event.preventDefault(); handleCreateGoal(event)" class="modal-form">
            
            <div style="margin-bottom: 15px;">
                <label for="goalTitle" style="display: block; font-weight: bold;">T√≠tulo:</label>
                <input type="text" id="goalTitle" required>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label for="goalDescription" style="display: block; font-weight: bold;">Descripci√≥n (Opcional):</label>
                <textarea id="goalDescription" rows="3"></textarea>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label for="goalDueDate" style="display: block; font-weight: bold;">Fecha L√≠mite:</label>
                <input type="date" id="goalDueDate" required>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label for="goalMetric" style="display: block; font-weight: bold;">M√©trica (Ej: veces por semana):</label>
                <input type="text" id="goalMetric">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label for="goalTarget" style="display: block; font-weight: bold;">Objetivo (Ej: 3):</label>
                <input type="number" id="goalTarget">
            </div>

            <div id="status-field" style="margin-bottom: 15px; display: none;"> 
                <label for="goalStatus" style="display: block; font-weight: bold;">Estado de la Meta:</label>
                <select id="goalStatus">
                    <option value="PENDING">PENDIENTE</option>
                    <option value="IN_PROGRESS">EN PROGRESO</option>
                    <option value="COMPLETED">COMPLETADA</option>
                    <option value="ARCHIVED">ARCHIVADA</option>
                </select>
            </div>
            
            <button type="submit" style="padding: 10px 20px; background-color: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Guardar Meta</button>
        </form>
    </div>
</div>


<script>
    // üö® CR√çTICO: REEMPLAZA 'URL_DE_TU_RENDER_BACKEND' CON LA URL REAL DE TU BACKEND EN RENDER (EJ: https://coter-backend.onrender.com)
    const API_BASE_URL = 'https://coter-backend.onrender.com/api'; 
    let currentPatientId = null; 
    let currentGoalId = null;
    let patientGoalsCache = []; 

    // --- Funciones de Utilidad y Auth ---

    function getToken() {
        return localStorage.getItem('token');
    }
    
    function getAuthHeaders() {
        return {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getToken()}`
        };
    }
    
    function showAlert(id, message, isError = false) {
        const alertElement = document.getElementById(id);
        if (!alertElement) return;

        alertElement.textContent = message;
        alertElement.style.display = 'block';
        alertElement.style.padding = '10px';
        alertElement.style.borderRadius = '4px';

        if (isError) {
            alertElement.style.backgroundColor = '#fdd';
            alertElement.style.color = 'var(--primary-color)';
        } else {
            alertElement.style.backgroundColor = '#dfd';
            alertElement.style.color = 'var(--success-color)';
        }

        setTimeout(() => {
            alertElement.style.display = 'none';
        }, 8000);
    }

    async function handleResponseError(response) {
        let errorDetail = `Error ${response.status} (${response.statusText}): El servidor no respondi√≥ con JSON v√°lido.`;
        
        try {
            const errorJson = await response.json();
            errorDetail = errorJson.message || 'Error del servidor sin mensaje espec√≠fico.';
        } catch (e) {
            const errorText = await response.text();
            errorDetail = errorText.substring(0, 200);
        }
        
        throw new Error(`¬°FALLO EN LA CONEXI√ìN! Status ${response.status}. Detalle: ${errorDetail}`);
    }

    function checkAuthentication() {
        const token = getToken();
        const role = localStorage.getItem('userRole');
        
        if (!token || role !== 'THERAPIST') {
            alert('Acceso no autorizado. Ser√°s redirigido al login.');
            window.location.href = 'index.html';
            return;
        }
        
        loadPatients();
    }

    function logout() {
        localStorage.clear();
        window.location.href = 'index.html';
    }

    function showPatientListView() {
        document.getElementById('patients-list-view').style.display = 'block';
        document.getElementById('patient-details-view').style.display = 'none';
        currentPatientId = null; 
        patientGoalsCache = []; 
    }

    // ‚≠ê L√ìGICA DE ASIGNACI√ìN DE PACIENTE (CORREGIDA E INTEGRADA) ‚≠ê

    async function assignPatient(form) {
        const email = document.getElementById('patientEmail').value;
        const messageDiv = document.getElementById('assign-message');
        messageDiv.innerHTML = '';
        
        try {
            // CR√çTICO: La ruta es /api/therapist/assign, usando POST.
            // Si el backend sigue usando PATCH, ¬°cambia la ruta a POST en therapistRoutes.js!
            const response = await fetch(`${API_BASE_URL}/therapist/assign`, {
                method: 'POST', // Aseguramos el m√©todo correcto
                headers: getAuthHeaders(),
                body: JSON.stringify({ patientEmail: email })
            });

            if (!response.ok) {
                await handleResponseError(response);
            }

            const result = await response.json();
            
            showAlert('assign-message', result.message, false);
            form.reset();
            loadPatients(); // Recargar la lista de pacientes
            // El mensaje de resultado del backend ser√° algo como: "Paciente [Nombre] asignado correctamente."

        } catch (error) {
            showAlert('assign-message', error.message, true);
        }
    }
    
    // --- L√ìGICA DE DETALLES, METAS Y CRUD ---
    
    async function loadPatients() {
        const list = document.getElementById('patients-list');
        list.innerHTML = 'Cargando...';
        showPatientListView();

        try {
            const response = await fetch(`${API_BASE_URL}/therapist/patients`, {
                method: 'GET',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                await handleResponseError(response);
            }

            const result = await response.json();
            // Asumo que el backend devuelve { data: { patients: [...] } }
            const activePatients = result.data.patients || []; 

            if (activePatients.length === 0) {
                list.innerHTML = '<p>A√∫n no tienes pacientes asignados o todos est√°n archivados.</p>';
                return;
            }

            list.innerHTML = activePatients.map(p => `
                <div class="patient-card">
                    <div>
                        <strong>${p.firstName || 'Sin Nombre'} ${p.lastName || ''}</strong>
                        <p>Email: ${p.email}</p>
                    </div>
                    <button onclick="viewPatientDetails('${p.id}')">Ver Detalles</button>
                </div>
            `).join('');

        } catch (error) {
            list.innerHTML = `<p style="color: var(--primary-color);">Error al cargar pacientes: ${error.message}</p>`;
        }
    }


    async function viewPatientDetails(patientId) {
        document.getElementById('patients-list-view').style.display = 'none';
        document.getElementById('patient-details-view').style.display = 'block';

        const nameHeader = document.getElementById('patient-detail-name');
        const checkinsList = document.getElementById('checkins-list');
        const goalsList = document.getElementById('goals-for-patient-list');
        const createGoalButton = document.getElementById('create-goal-button');
        const goalFilterStatus = document.getElementById('goalFilterStatus');

        nameHeader.textContent = 'Cargando...';
        checkinsList.innerHTML = 'Cargando check-ins...';
        goalsList.innerHTML = 'Cargando metas...';
        
        currentPatientId = patientId; 
        createGoalButton.setAttribute('onclick', `openCreateGoalModal('${patientId}')`);
        goalFilterStatus.value = 'ALL';

        try {
            // Nota: Este endpoint puede requerir modificar tu backend para incluir checkins y metas 
            // en la respuesta de /therapist/patient/:patientId, si a√∫n no lo hace.
            const response = await fetch(`${API_BASE_URL}/therapist/patient/${patientId}`, {
                method: 'GET',
                headers: getAuthHeaders()
            });

            const goalsResponse = await fetch(`${API_BASE_URL}/therapist/goals/${patientId}`, {
                method: 'GET',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                await handleResponseError(response);
            }
            if (!goalsResponse.ok) {
                await handleResponseError(goalsResponse);
            }

            const patientData = await response.json();
            const goalsData = await goalsResponse.json();
            
            const patient = patientData.data.patient;
            const checkins = patient.checkins || []; // Asumo que el backend los incluir√≠a si existen.
            const assignedGoals = goalsData.data.goals || [];

            nameHeader.textContent = `${patient.firstName} ${patient.lastName || ''} (${patient.email})`;

            // 1. Renderizar Check-ins (Asumo que los datos de checkins vienen en la respuesta de /patient/:patientId)
            if (checkins.length > 0) {
                checkinsList.innerHTML = checkins.map(c => `
                    <div class="checkin-card">
                        <span class="score">√Ånimo: ${c.moodScore}/5</span>
                        <small>(${new Date(c.date).toLocaleDateString()} ${new Date(c.date).toLocaleTimeString()})</small>
                        <p>Notas: ${c.notes || 'N/A'}</p>
                    </div>
                `).join('');
            } else {
                checkinsList.innerHTML = '<p>El paciente a√∫n no ha registrado check-ins.</p>';
            }

            // 2. Renderizar Metas
            patientGoalsCache = assignedGoals;
            filterGoals(); 

        } catch (error) {
            document.getElementById('patient-details-view').innerHTML = `<p style="color: var(--primary-color);">Error al cargar detalles: ${error.message}</p>
                <button onclick="showPatientListView()" style="margin-top: 15px; padding: 8px 15px; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">‚Üê Volver a la Lista</button>`;
        }
    }

    function filterGoals() {
        const filterValue = document.getElementById('goalFilterStatus').value;
        const goalsList = document.getElementById('goals-for-patient-list');
        
        const filteredGoals = patientGoalsCache.filter(goal => {
            if (filterValue === 'ALL') {
                return true;
            }
            return goal.status === filterValue;
        });

        if (filteredGoals.length === 0) {
            goalsList.innerHTML = `<p>No hay metas con el estado "${filterValue.replace('_', ' ')}".</p>`;
            return;
        }

        const statusClass = (status) => `status-badge status-${status}`;

        goalsList.innerHTML = filteredGoals.map(g => `
            <div class="goal-card-therapist">
                <strong>${g.title}</strong>
                <span class="${statusClass(g.status)}" style="float: right;">${g.status.replace('_', ' ')}</span>
                <p>${g.description || 'Sin descripci√≥n.'}</p>
                <p><small>L√≠mite: ${new Date(g.dueDate).toLocaleDateString()}</small></p>
                <p><small>M√©trica/Objetivo: ${g.metric || 'N/A'} / ${g.target || 'N/A'}</small></p>
                <button onclick="openEditGoalModal(
                    '${g.id}', 
                    '${g.title.replace(/'/g, "\\'")}', 
                    '${g.description ? g.description.replace(/'/g, "\\'") : ''}', 
                    '${g.dueDate.substring(0, 10)}', 
                    '${g.metric || ''}', 
                    '${g.target || ''}', 
                    '${g.status}'
                )" style="margin-top: 10px; padding: 5px 10px; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Editar</button>
            </div>
        `).join('');
    }
    
    // Funciones de Modal y CRUD (Deben ser implementadas)

    function openCreateGoalModal(patientId) {
        currentGoalId = null;
        document.getElementById('modal-title').textContent = 'Crear Nueva Meta';
        document.getElementById('status-field').style.display = 'none';
        document.getElementById('create-goal-form').reset();
        document.getElementById('goal-modal').style.display = 'block';
    }

    function openEditGoalModal(id, title, description, dueDate, metric, target, status) {
        currentGoalId = id;
        document.getElementById('modal-title').textContent = 'Editar Meta';
        
        document.getElementById('goalTitle').value = title;
        document.getElementById('goalDescription').value = description;
        document.getElementById('goalDueDate').value = dueDate;
        document.getElementById('goalMetric').value = metric;
        document.getElementById('goalTarget').value = target;
        
        const statusField = document.getElementById('status-field');
        statusField.style.display = 'block';
        document.getElementById('goalStatus').value = status;
        
        document.getElementById('goal-modal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('goal-modal').style.display = 'none';
        document.getElementById('create-goal-form').reset();
        document.getElementById('goal-form-message').innerHTML = '';
        currentGoalId = null;
    }

    async function handleCreateGoal(e) {
        const title = document.getElementById('goalTitle').value;
        const description = document.getElementById('goalDescription').value;
        const dueDate = document.getElementById('goalDueDate').value;
        const metric = document.getElementById('goalMetric').value;
        const target = document.getElementById('goalTarget').value;
        const status = document.getElementById('goalStatus').value;
        const messageDiv = document.getElementById('goal-form-message');
        
        messageDiv.innerHTML = '';
        messageDiv.textContent = 'Guardando...';

        const data = {
            title,
            description,
            dueDate,
            metric,
            target: parseInt(target) || 0,
            patientId: currentPatientId
        };
        
        let endpoint = '/therapist/goals';
        let method = 'POST';

        if (currentGoalId) {
            // Si estamos editando
            endpoint = `/therapist/goals/${currentGoalId}`;
            method = 'PATCH';
            data.status = status;
        }

        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                method,
                headers: getAuthHeaders(),
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                await handleResponseError(response);
            }

            const result = await response.json();

            showAlert('goal-form-message', `Meta ${currentGoalId ? 'actualizada' : 'creada'} con √©xito.`, false);
            
            // Recargar vista y cerrar modal
            viewPatientDetails(currentPatientId); 
            closeModal();

        } catch (error) {
            showAlert('goal-form-message', error.message, true);
        }
    }

    async function archivePatient() {
        if (!currentPatientId || !confirm('¬øEst√°s seguro de que quieres ARCHIVAR a este paciente? Podr√°s restaurarlo m√°s tarde.')) {
            return;
        }
        
        // Esta funcionalidad requiere una ruta PATCH en el backend (ej: /api/therapist/archive/:patientId)
        alert('Funcionalidad de Archivar no implementada en el backend a√∫n.');
    }

    async function deletePatient() {
        if (!currentPatientId || !confirm('ADVERTENCIA: ¬øEst√°s seguro de que quieres ELIMINAR permanentemente a este paciente? Esto es irreversible.')) {
            return;
        }
        
        // Esta funcionalidad requiere una ruta DELETE en el backend (ej: /api/therapist/patient/:patientId)
        alert('Funcionalidad de Eliminar no implementada en el backend a√∫n.');
    }
    
    window.onload = checkAuthentication;
</script>
</body>
</html>